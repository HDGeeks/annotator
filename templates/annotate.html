<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Annotate Row {{ idx+1 }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #f5f6fa; padding: 30px; }
        .card { border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
        .input-box {
            white-space: pre-wrap;
            background: #eef1f7;
            border-left: 4px solid #4a6cf7;
            padding: 12px;
            border-radius: 6px;
            font-size: 1.05rem;
        }
        .annotation-box {
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e6e6ee;
        }
        label { margin-top: 10px; font-weight: 600; opacity: 0.85; }
    </style>
</head>

<body>

<div class="container">
    <div class="card p-4">

        <h3 class="mb-3">Annotating Row {{ idx+1 }} / {{ total }}</h3>

        <!-- Progress Bar -->
        <div class="progress mb-4" style="height: 10px;">
            <div class="progress-bar" role="progressbar"
                 style="width: {{ ((idx+0.0001)/total)*100 }}%;">
            </div>
        </div>

        <h5 class="mb-2 text-muted">Input text</h5>
        <div class="input-box mb-4">
            {{ row.input }}
        </div>

        <form method="POST">
            <input type="hidden" name="total_items" value="{{ row.output|length }}">
            <input type="hidden" name="goto_row" id="goto_row">
            <input type="hidden" name="action" id="action_field" value="save">

            {% for item in row.output %}
            <div class="annotation-box p-3 mb-4">

                <h6 class="fw-bold mb-3">Annotation {{ loop.index }}</h6>

                <!-- Aspect -->
                <label>Aspect</label>
                <select class="form-select aspect-select"
                        name="aspect_{{ loop.index0 }}"
                        data-index="{{ loop.index0 }}">
                    {% for a in aspects %}
                        <option value="{{ a }}" {% if item.aspect == a %}selected{% endif %}>{{ a }}</option>
                    {% endfor %}
                </select>

                <!-- Polarity -->
                <label>Polarity</label>
                <select class="form-select polarity-select"
                        name="polarity_{{ loop.index0 }}"
                        data-index="{{ loop.index0 }}">
                    {% for p in polarity_options %}
                        <option value="{{ p }}" {% if item.polarity == p %}selected{% endif %}>{{ p }}</option>
                    {% endfor %}
                </select>

                <!-- Emotion -->
                <label>Emotion (Aspect + Polarity Filtered)</label>
                <select class="form-select emotion-select"
                        name="emotion_{{ loop.index0 }}"
                        data-index="{{ loop.index0 }}"
                        data-current="{{ item.emotion }}">
                </select>

            </div>
            {% endfor %}

            <!-- NAVIGATION -->
            <div class="d-flex justify-content-between mt-4">
                {% if row_index > 0 %}
                <button type="button" class="btn btn-outline-secondary px-4"
                        onclick="document.getElementById('goto_row').value={{ row_index - 1 }};
                                 document.getElementById('action_field').value='navigate';
                                 this.form.submit();">
                    ← Previous
                </button>
                {% else %}
                <button type="button" class="btn btn-outline-secondary px-4" disabled>← Previous</button>
                {% endif %}

                <button type="submit" class="btn btn-success px-5"
                        onclick="document.getElementById('action_field').value='save';">
                    Save
                </button>

                {% if row_index + 1 < total %}
                <button type="button" class="btn btn-outline-primary px-4"
                        onclick="document.getElementById('goto_row').value={{ row_index + 1 }};
                                 document.getElementById('action_field').value='navigate';
                                 this.form.submit();">
                    Next →
                </button>
                {% else %}
                <button type="button" class="btn btn-outline-primary px-4" disabled>Next →</button>
                {% endif %}
            </div>

        </form>

    </div>
</div>


<!-- SMART DYNAMIC FILTERING JS -->
<script>
const emotions = {{ emotions | tojson }};
const allPos = {{ pos_list | tojson }};
const allNeg = {{ neg_list | tojson }};
const allNeu = {{ neu_list | tojson }};


function updateDropdown(i) {
    const aspect = document.querySelector(`[name="aspect_${i}"]`).value;
    const polarity = document.querySelector(`[name="polarity_${i}"]`).value;
    const dropdown = document.querySelector(`[name="emotion_${i}"]`);
    const current = dropdown.getAttribute("data-current");

    dropdown.innerHTML = "";

    // None
    dropdown.innerHTML += `<option value="">None</option>`;

    // Suggested group
    if (emotions[aspect] && emotions[aspect][polarity]) {
        dropdown.innerHTML += `<optgroup label="Suggested: ${aspect} (${polarity})">`;
        for (const emo of emotions[aspect][polarity]) {
            dropdown.innerHTML += `<option value="${emo}" ${emo===current?"selected":""}>${emo}</option>`;
        }
        dropdown.innerHTML += `</optgroup>`;
    }

    // Global fallback
    dropdown.innerHTML += `<optgroup label="All Positive">`;
    for (const emo of allPos)
        dropdown.innerHTML += `<option value="${emo}" ${emo===current?"selected":""}>${emo}</option>`;
    dropdown.innerHTML += `</optgroup>`;

    dropdown.innerHTML += `<optgroup label="All Negative">`;
    for (const emo of allNeg)
        dropdown.innerHTML += `<option value="${emo}" ${emo===current?"selected":""}>${emo}</option>`;
    dropdown.innerHTML += `</optgroup>`;

    dropdown.innerHTML += `<optgroup label="All Neutral">`;
    for (const emo of allNeu)
        dropdown.innerHTML += `<option value="${emo}" ${emo===current?"selected":""}>${emo}</option>`;
    dropdown.innerHTML += `</optgroup>`;
}


// initialize all emotion dropdowns
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".emotion-select").forEach(sel => {
        updateDropdown(sel.dataset.index);
    });
});

// Trigger updates when aspect OR polarity changes
document.querySelectorAll(".aspect-select, .polarity-select").forEach(sel => {
    sel.addEventListener("change", () => {
        updateDropdown(sel.dataset.index);
    });
});
</script>

</body>
</html>