import json
from flask import Flask, request, render_template, redirect, url_for

app = Flask(__name__)

PROGRESS = 0
EDIT_MODE = True
INPUT_PATH = "input.jsonl"
OUTPUT_PATH = "output.jsonl"

# Load data
with open(INPUT_PATH, "r", encoding="utf-8") as f:
    DATA = [json.loads(line) for line in f]

aspects = ["service", "food", "ambience"]
polarity_options = ["positive", "neutral", "negative"]
emotions = {
    "service": {
        "positive": ["happy", "satisfied"],
        "negative": ["angry", "disappointed"]
    },
    "food": {
        "positive": ["delighted", "pleased"],
        "negative": ["disgusted", "unhappy"]
    },
    "positive": ["joyful", "content"],
    "negative": ["sad", "frustrated"],
    "neutral": ["indifferent", "calm"]
}

@app.route("/annotate", methods=["GET", "POST"])
def annotate():
    global PROGRESS

    row_index = request.args.get("row", type=int)
    if row_index is None:
        row_index = PROGRESS

    row = DATA[row_index]

    if request.method == "POST":
        total_items = int(request.form.get("total_items", 0))
        edited_output = []
        for i in range(total_items):
            aspect = request.form.get(f"aspect_{i}")
            polarity = request.form.get(f"polarity_{i}")
            emotion = request.form.get(f"emotion_{i}", "")
            edited_output.append({
                "aspect": aspect,
                "polarity": polarity,
                "emotion": emotion
            })

        # --- Save logic for overwrite mode and append mode ---
        if EDIT_MODE:
            # Overwrite the row in the input dataset
            DATA[row_index]["output"] = edited_output
            with open(INPUT_PATH, "w", encoding="utf-8") as f:
                for r in DATA:
                    f.write(json.dumps(r, ensure_ascii=False) + "\n")
        else:
            # Overwrite or append output file row-by-row
            try:
                with open(OUTPUT_PATH, "r+", encoding="utf-8") as f:
                    lines = f.readlines()
                    new_entry = json.dumps({
                        "input": row["input"],
                        "output": edited_output
                    }, ensure_ascii=False) + "\n"

                    if row_index < len(lines):
                        lines[row_index] = new_entry
                    else:
                        lines.append(new_entry)

                    f.seek(0)
                    f.writelines(lines)
                    f.truncate()
            except FileNotFoundError:
                with open(OUTPUT_PATH, "w", encoding="utf-8") as f:
                    f.write(json.dumps({
                        "input": row["input"],
                        "output": edited_output
                    }, ensure_ascii=False) + "\n")

        # Determine next row based on navigation buttons
        next_row = request.form.get("goto_row", type=int)
        if next_row is not None:
            if next_row > PROGRESS:
                PROGRESS = next_row
            return redirect(url_for("annotate", row=next_row))

        return redirect(url_for("annotate"))

    return render_template(
        "annotate.html",
        idx=row_index,
        row=row,
        total=len(DATA),
        row_index=row_index,
        aspects=aspects,
        polarity_options=polarity_options,
        emotions=emotions
    )